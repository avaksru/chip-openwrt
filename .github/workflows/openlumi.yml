name: Build OpenWrt with Matter Host

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install -y \
            build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python python2.7-dev python3 unzip wget \
            python3-distutils python3-setuptools python3-dev rsync subversion \
            gcc g++ pkg-config libdbus-1-dev libglib2.0-dev ninja-build python3-venv \
            swig time xsltproc zlib1g-dev

      - name: Download and extract OpenWrt
        run: |
          wget https://github.com/openlumi/openwrt/archive/refs/tags/v24.10.0-20250212.tar.gz
          tar xvzf v24.10.0-20250212.tar.gz
          mv openwrt-24.10.0-20250212 openwrt
          cd openwrt
          pwd  # Log current directory for debugging

      - name: Configure OpenWrt for Matter Host
        run: |
          cd openwrt
          cat << EOF > config_gtw360
          CONFIG_PACKAGE_chip=y

          #
          # Configuration for Matter Host
          #
          CONFIG_CHIP_TOOL=y
          CONFIG_CHIP_OTA_PROVIDER=y
          CONFIG_CHIP_BRIDGE=y
          # end of Configuration for Matter Host
          EOF
          cp config_gtw360 .config
          make -j$(nproc) defconfig

      - name: Add custom feed
        run: |
          cd openwrt
          echo "src-git chip https://github.com/avaksru/matter-openwrt.git" >> feeds.conf.default
          cat feeds.conf.default  # Log feed configuration for debugging

      - name: Update and install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a || { echo "Feed update failed"; exit 1; }
          ls -la feeds/  # Log feeds directory contents for debugging
          if [ ! -d "feeds/chip" ]; then
            echo "Error: feeds/chip directory not found"
            exit 1
          fi
          ./scripts/feeds install -a || { echo "Feed install failed"; exit 1; }

      - name: Compile chip package
        run: |
          cd openwrt
          make -j$(nproc) package/chip/compile V=s || { echo "Compilation failed"; exit 1; }

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-chip-package
          path: openwrt/bin/packages/*/*/chip/*.ipk
